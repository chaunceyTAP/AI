{"guid":"180724fa-d22a-4b6d-bff0-daeeeec5d279","title":"Inbound SMS workflow activity for Mid-sourcing infrastructure","path":"help\\technotes\\using\\inbound-sms-wf.md","fullText":"---\nproduct: campaign\ntitle: Inbound SMS workflow activity for Mid-sourcing infrastructure\ndescription: Inbound SMS workflow activity for Mid-sourcing infrastructure\nfeature: Technote, SMS\nexl-id: 756039b2-5f57-4dc5-8166-a421206b886b\n---\n# Inbound SMS workflow activity for Mid-sourcing infrastructure {#inbound-sms-wf}\n\n## Limitations {#limitations}\n\n* This use case only applies to the Marketing instance where you collect inSMS data from the Mid-sourcing instance(s).\n* Do not implement this use case on the Mid-sourcing instance.\n* Only one custom workflow per external Mid-sourcing account.\n\n## Implementation {#implementation}\n\n1. Add an extension to the `nms:inSMS` schema on your Marketing instance. The extension will add a new attribute to the `nms:inSMS` schema and keep track of the inSMS record primary key coming from the Mid-sourcing instance.\n\n    ``` xml\n\n    <element img=\"nms:miniatures/mini-sms.png\" label=\"Incoming SMS\"\n           labelSingular=\"Incoming SMS\" name=\"inSMS\">\n    <dbindex name=\"midInSMSId\" unique=\"false\">\n      <keyfield xpath=\"@extAccount-id\"/>\n      <keyfield xpath=\"@midInSMSId\"/>\n    </dbindex>\n \n    <attribute label=\"External Mid SMS ID\" name=\"midInSMSId\" type=\"long\"/>\n    </element>\n\n    ```\n\n1. To apply the modifications made to the schemas, launch the database update wizard. This wizard is accessible via **Tools** > **Advanced** > **Update database structure**. It checks whether the physical structure of the database matches its logical description and executes the SQL update scripts. [Learn more](../../configuration/using/updating-the-database-structure.md)\n\n1. Stop and backup your workflow containing the **Inbound SMS activity**. \n    \n    Backup the corresponding option pointer with the following format `SMS_MO_INDEX_{internal name of the workflow}_{name of the insms workflow activity}_{internal name of the external account to access the mid}`.\n\n    [Learn more on backup](../../production/using/backup.md)\n\n1. (**OPTIONAL**) if you are already using a Scheduler activity, open the workflow and reconfigure it as follows:\n\n    1. Replicate the current settings from the **Schedule** tab of your **Inbound SMS** activity into your external **Scheduler** activity.\n\n    1. Disable the current setting in the **Schedule** tab of **Inbound SMS** activity.\n\n        ![](assets/inbound_sms_1.png)\n\n1. Update the **Inbound SMS** custom script.\n\n    Replace the below block. Note that this script may vary if you previously customized this code.\n\n    ``` Javascript\n\n    var lastSynchKey = getOption('SMS_MO_INDEX_WKF1105_inSmsUS_smsmidus');\n \n    var smsId = application.getNewIds(1);\n \n    xtk.session.Write(<inSMS xtkschema=\"nms:inSMS\" _operation=\"insert\"\n        id={smsId}\n        origin={smsMessage.origin}\n        message={smsMessage.message}\n        providerId={smsMessage.messageId}/>);\n\n    return 2;\n    ```\n\n    With the following new custom script to update inSMS data based on a composite key, combining the primary key of the Mid-sourcing record and the external account ID of the Marketing SMS routing.\n\n    Follow the prerequesites below:\n\n    * Enter the real value for `<EXTERNAL_ACCOUNT_ID>`, e,g, `var iExtAccountId=72733155`.\n    * Make sure to keep the following elements in the custom script:\n        * `_operation=\"insertOrUpdate\"`\n        * `_key=\"@midInSMSId,@extAccount-id\"`\n        * `midInSMSId={smsMessage.id}`\n        * `inSms.@[\"extAccount-id\"] = iExtAccountId;{}`\n\n    ``` Javascript\n\n    // please enter real external account ID to replace <EXTERNAL ACCOUNT ID>\n    var iExtAccountId=<EXTERNAL_ACCOUNT_ID>;\n    \n    var inSms = <inSMS xtkschema=\"nms:inSMS\" _operation=\"insertOrUpdate\"\n\n                _key=\"@midInSMSId,@extAccount-id\"\n                midInSMSId={smsMessage.id}\n                message={smsMessage.message}\n                origin={smsMessage.origin}\n                providerId={smsMessage.providerId}\n                alias={smsMessage.alias}\n                messageDate = {smsMessage.messageDate}\n                receivalDate = {smsMessage.receivalDate}\n                deliveryDate = {smsMessage.deliveryDate}\n                largeAccount = {smsMessage.largeAccount}\n                countryCode = {smsMessage.countryCode}\n                operatorCode = {smsMessage.operatorCode}\n                linkedSmsId={smsMessage.linkedSmsId}\n                separator = {smsMessage.separator}/>\n\n    inSms.@[\"extAccount-id\"] = iExtAccountId;\n  \n    xtk.session.Write(inSms);\n \n    return 2;\n\n    ```\n\n1. Update the Inbound SMS advanced initialization script with the following script.\n\n    The script will reset the primary key pointer to 24 hours prior. The workflow will attempt to reprocess all inSMS data from the Mid-sourcing instance within the previous 24 hours and add any missing data to the Marketing instance.\n\n    ``` Javascript\n\n    // please enter real external account ID to replace <EXTERNAL_ACCOUNT_ID>\n    // please enter real pointer option name to replace '<POINTER_OPTION_NAME>'\n    // OPTION NAME format: SMS_MO_INDEX_{internal name of the workflow}_inSms_{internal name of the external account to access the mid}\n \n    var queryDef = xtk.queryDef.create(\n        <queryDef operation=\"getIfExists\" schema=\"nms:inSMS\" lineCount=\"1\">\n        <select>\n            <node expr=\"@midInSMSId\" alias=\"@midInSMSId\"/>\n        </select>\n        <where>\n            <condition expr=\"@midInSMSId != 0\"/>\n            <condition expr={\"@created > SubHours(GetDate(), 24)\"}/>\n            <condition expr={\"[@extAccount-id]=<EXTERNAL_ACCOUNT_ID>\"}/>\n        </where>\n        <orderBy>\n            <node expr=\"@midInSMSId\"/>\n        </orderBy>\n        </queryDef>);\n     \n    var res = parseInt(queryDef.ExecuteQuery().@midInSMSId.toString());\n \n    if( !isNaN(res) )\n    setOption('<POINTER_OPTION_NAME>', res);\n\n    ```\n\n    >[!WARNING]\n    >\n    > * If several SMS routing accounts are linked to the same Mid-sourcing instance, only a single workflow per Mid-sourcing instance is permitted.\n    > * You can use any external account ID. The role of the foreign key is to maintain data reconciliation integrity in scenarios involving different Mid-sourcing servers where the Mid-sourcing SMS ID might be identical across other Mid-sourcing instances.\n    > * If there are multiple inSMS workflows per Mid-sourcing instance, data duplication may occur as the Mid-sourcing SMS ID remains constant while the external account IDs vary.\n\n1. Save and restart the workflow.\n","headers":[["title","Inbound SMS workflow activity for Mid-sourcing infrastructure"],["description","Inbound SMS workflow activity for Mid-sourcing infrastructure"],["feature","Technote, SMS"]],"sections":[{"section":"Inbound SMS workflow activity for Mid-sourcing infrastructure","sectionId":"0eca986a-ca21-44ce-8f82-1c3614aa153f","paragraphs":[]},{"section":"Limitations","sectionId":"dc365771-8e17-4be5-a812-dbf0637634c1","paragraphs":["This use case only applies to the Marketing instance where you collect inSMS data from the Mid-sourcing instance(s).\nDo not implement this use case on the Mid-sourcing instance.\nOnly one custom workflow per external Mid-sourcing account."]},{"section":"Implementation","sectionId":"05f38f5d-b8da-4be7-90b7-d4bc63774142","paragraphs":["Add an extension to the nms:inSMS schema on your Marketing instance. The extension will add a new attribute to the nms:inSMS schema and keep track of the inSMS record primary key coming from the Mid-sourcing instance.","<element img=\"nms:miniatures/mini-sms.png\" label=\"Incoming SMS\"\n       labelSingular=\"Incoming SMS\" name=\"inSMS\">\n<dbindex name=\"midInSMSId\" unique=\"false\">\n  <keyfield xpath=\"@extAccount-id\"/>\n  <keyfield xpath=\"@midInSMSId\"/>\n</dbindex>","<attribute label=\"External Mid SMS ID\" name=\"midInSMSId\" type=\"long\"/>\n</element>","To apply the modifications made to the schemas, launch the database update wizard. This wizard is accessible via Tools > Advanced > Update database structure. It checks whether the physical structure of the database matches its logical description and executes the SQL update scripts. Learn more","Stop and backup your workflow containing the Inbound SMS activity.","Backup the corresponding option pointer with the following format SMS_MO_INDEX___.","Learn more on backup","(OPTIONAL) if you are already using a Scheduler activity, open the workflow and reconfigure it as follows:","Replicate the current settings from the Schedule tab of your Inbound SMS activity into your external Scheduler activity.","Disable the current setting in the Schedule tab of Inbound SMS activity.","Update the Inbound SMS custom script.","Replace the below block. Note that this script may vary if you previously customized this code.","var lastSynchKey = getOption('SMS_MO_INDEX_WKF1105_inSmsUS_smsmidus');","var smsId = application.getNewIds(1);","xtk.session.Write(<inSMS xtkschema=\"nms:inSMS\" _operation=\"insert\"\n    id=\n    origin=\n    message=\n    providerId=/>);","return 2;","With the following new custom script to update inSMS data based on a composite key, combining the primary key of the Mid-sourcing record and the external account ID of the Marketing SMS routing.","Follow the prerequesites below:","Enter the real value for <EXTERNAL_ACCOUNT_ID>, e,g, var iExtAccountId=72733155.\nMake sure to keep the following elements in the custom script:_operation=\"insertOrUpdate\"\n_key=\"@midInSMSId,@extAccount-id\"\nmidInSMSId=\ninSms.@[\"extAccount-id\"] = iExtAccountId;","// please enter real external account ID to replace <EXTERNAL ACCOUNT ID>\nvar iExtAccountId=<EXTERNAL_ACCOUNT_ID>;","var inSms = <inSMS xtkschema=\"nms:inSMS\" _operation=\"insertOrUpdate\"","_key=\"@midInSMSId,@extAccount-id\"\n            midInSMSId=\n            message=\n            origin=\n            providerId=\n            alias=\n            messageDate = \n            receivalDate = \n            deliveryDate = \n            largeAccount = \n            countryCode = \n            operatorCode = \n            linkedSmsId=\n            separator = />","inSms.@[\"extAccount-id\"] = iExtAccountId;","xtk.session.Write(inSms);","return 2;","Update the Inbound SMS advanced initialization script with the following script.","The script will reset the primary key pointer to 24 hours prior. The workflow will attempt to reprocess all inSMS data from the Mid-sourcing instance within the previous 24 hours and add any missing data to the Marketing instance.","// please enter real external account ID to replace <EXTERNAL_ACCOUNT_ID>\n// please enter real pointer option name to replace '<POINTER_OPTION_NAME>'\n// OPTION NAME format: SMS_MO_INDEX__inSms_","var queryDef = xtk.queryDef.create(\n    <queryDef operation=\"getIfExists\" schema=\"nms:inSMS\" lineCount=\"1\">\n    <select>\n        <node expr=\"@midInSMSId\" alias=\"@midInSMSId\"/>\n    </select>\n    <where>\n        <condition expr=\"@midInSMSId != 0\"/>\n        <condition expr=/>\n        <condition expr=/>\n    </where>\n    <orderBy>\n        <node expr=\"@midInSMSId\"/>\n    </orderBy>\n    </queryDef>);\n \nvar res = parseInt(queryDef.ExecuteQuery().@midInSMSId.toString());","if( !isNaN(res) )\nsetOption('<POINTER_OPTION_NAME>', res);","WARNING","If several SMS routing accounts are linked to the same Mid-sourcing instance, only a single workflow per Mid-sourcing instance is permitted.\nYou can use any external account ID. The role of the foreign key is to maintain data reconciliation integrity in scenarios involving different Mid-sourcing servers where the Mid-sourcing SMS ID might be identical across other Mid-sourcing instances.\nIf there are multiple inSMS workflows per Mid-sourcing instance, data duplication may occur as the Mid-sourcing SMS ID remains constant while the external account IDs vary.","Save and restart the workflow."]}]}