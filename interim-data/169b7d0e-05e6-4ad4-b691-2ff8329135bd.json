{"guid":"169b7d0e-05e6-4ad4-b691-2ff8329135bd","title":"Scripting and coding guidelines","path":"help\\installation\\using\\scripting-coding-guidelines.md","fullText":"---\nproduct: campaign\ntitle: Scripting and coding guidelines\ndescription: Learn more about the guidelines to follow when developing in Adobe Campaign (workflows, Javascript, JSSP, etc.)\nfeature: Installation, Instance Settings\naudience: installation\ncontent-type: reference\ntopic-tags: prerequisites-and-recommendations-\nexl-id: 1f96c3df-0ef2-4f5f-9c36-988cbcc0769f\n---\n# Scripting and coding guidelines {#scripting-coding-guidelines}\n\n\n\n## Scripting\n\nFor more details, refer to [Campaign JSAPI documentation](https://experienceleague.adobe.com/developer/campaign-api/api/index.html).\n\nIf you script using workflow, web applications, jssp, follow these best practices:\n\n* Try to avoid using SQL statements as much as you can.\n\n* If you need to, use parameterized (prepare statement) functions instead of string concatenation.\n\n    Bad practice:\n\n    ```\n    sqlGetInt( \"select iRecipientId from NmsRecipient where sEmail ='\" + request.getParameter('email') +  \"'  limit 1\" )\n    ```\n\n    Good practice:\n\n    ```\n    sqlGetInt( \"select iRecipientId from NmsRecipient where sEmail = $(sz) limit 1\", request.getParameter('email'));\n    ```\n\n    >[!IMPORTANT]\n    >\n    >sqlSelect doesn't support this feature, so you have to use the query function of DBEngine class:\n\n    ```\n    var cnx = application.getConnection()\n    var stmt = cnx.query(\"SELECT sFirstName, sLastName FROM NmsRecipient where sEmail = $(sz)\", request.getParameter('email'))\n    for each(var row in stmt) logInfo(row[0] + \" : \" + row[1])\n    cnx.dispose()\n    ```\n\nTo avoid SQL injections, SQL functions must be added to the allowlist to be used in Adobe Campaign. Once they are added to the allowlist, they become visible to your operators in the expression editor. Refer to [this page](../../configuration/using/adding-additional-sql-functions.md).\n\n>[!IMPORTANT]\n>\n>If you are using a build that is older than 8140, the **XtkPassUnknownSQLFunctionsToRDBMS** option might be set to '1'. If you want to secure your database, delete this option (or set it to '0').\n\nIf you are using user input to build filters in queries or SQL statements, you always have to escape them (refer to [Campaign JSAPI documentation](https://experienceleague.adobe.com/developer/campaign-api/api/index.html) - Data protection: escaping functions). These functions are:\n\n* NL.XML.escape(data)\n* NL.SQL.escape(data)\n* NL.JS.escape(data)\n* NL.XML.escapeAttribute(data)\n\n## Securing your new data model\n\n### Folder base\n\nRefer to these pages:\n\n* [Folder access properties](../../platform/using/access-management.md)\n* [Linked folder](../../configuration/using/configuration.md#linked-folder)\n\n### Named rights\n\nIn addition to the folder-based security model, you can use named rights to limit operator actions:\n\n* You can add some system filters (sysFilter) to prevent reading/writing to your data (see [this page](../../configuration/using/filtering-schemas.md)).\n\n    ```\n    <sysFilter name=\"writeAccess\">    \n        <condition enabledIf=\"hasNamedRight('myNewRole')=false\" expr=\"FALSE\"/>  \n    </sysFilter>\n    ```\n\n* You can also protect some actions (SOAP method) defined in schemas. Just set the access attribute with the corresponding named right as the value.\n\n    ```\n    <method name=\"grantVIPAccess\" access=\"myNewRole\">\n        <parameters>\n    ...\n        </parameters>\n    </method>\n    ```\n\n    For more on this, refer to [this page](../../configuration/using/implementing-soap-methods.md).\n\n>[!IMPORTANT]\n>\n>You can use named rights in the command node in a navtree. It gives a better user experience but doesn't provide any protection (use only client side to hide / disable them). You have to use the access attribute.\n\n### Overflow table\n\nIf you need to protect confidential data (part of a schema) depending on the operator access level, do not hide them in the form definition (enabledIf/visibleIf conditions).\n\nThe full entity is loaded by the screen, you can also display them in column definition. To do this, you have to create an overflow table. Refer [this page](../../configuration/using/examples-of-schemas-edition.md#overflow-table).\n\n## Adding captchas in web applications\n\nIt is a good practice to add a captcha in public landing pages/subscription pages. Unfortunately, adding a captcha in DCE (Digital Content Editor) pages is not easy. We will show you how to add a v5 captcha or a Google reCAPTCHA.\n\nThe general way to add a captcha in the DCE is to create a personalization block to include it easily within the page content. You will have to add a **Script** activity and a **Test**.\n\n### Personalization block\n\n1. Go to **[!UICONTROL Resources]** > **[!UICONTROL Campaign Management]** > **[!UICONTROL Personalization blocks]** and create a new one.\n\n1. Use the **[!UICONTROL Web application]** content type and check **[!UICONTROL Visible in the customization menus]**.\n\n    For more information, refer to [this page](../../delivery/using/personalization-blocks.md).\n\n    Here is an example of a **Campaign captcha**:\n\n    ```javascript\n    <%\n    var captchaID = CaptchaIDGen();\n    %>\n    <img src=\"/nms/jsp/captcha.jsp?captchaID=<%=captchaID%>&width=200&height=50&minWordSize=8&maxWordSize=8\"/>\n    <input id=\"captchaValue\" name=\"captchaValue\" <%= String(ctx.vars.captchaValid) === \"false\" ? class=\"ui-state-error\" : \"\" %>>\n    <input type=\"hidden\" name=\"captchaID\" value=\"<%=captchaID%>\"/>\n    <%\n    if( serverForm.isInputErroneous(\"captchaValue\") ) {\n    %>\n    <script type=\"text/javascript\"> \n    $(\"#captchaValue\").addClass(\"ui-state-error\")\n    </script>\n    <%\n    }\n    %>\n    ```\n\n    * Lines 1 to 6 generate all needed inputs.\n    * Lines 7 to the end handle errors.\n    * Line 4 allows you to change captcha gray box size (width/height) and the length of generated word (minWordSize/maxWordSize).\n    * Before using Google reCAPTCHA, you must register on Google and create a new reCAPTCHA site.\n\n        `<div class=\"g-recaptcha\" data-sitekey=\"YOUR_SITE_KEY\"></div>`\n\n    You should be able to disable the validation button, but as we don't have any standard button/link, it's better to do it in the HTML itself. To learn how to do it, refer to [this page](https://developers.google.com/recaptcha/).\n\n### Updating your web application\n\n1. Access the properties of your web application to add a boolean variable named **captchaValid**.\n\n    ![](assets/scripting-captcha.png)\n\n1. Between the last page and the **[!UICONTROL Storage]** activity, add a **[!UICONTROL Script]** and a **[!UICONTROL Test]**.\n\n    Plug the branch **[!UICONTROL True]** to the **[!UICONTROL Storage]** and the other one to the page which will have the captcha.\n\n    ![](assets/scripting-captcha2.png)\n\n1. Edit the condition of the branch True with `\"[vars/captchaValid]\"` equals True.\n\n    ![](assets/scripting-captcha3.png)\n\n1. Edit the **[!UICONTROL Script]** activity. The content will depend on the chosen captcha engine. \n\n1. Finally, you can add your personalized block in the page: refer to [this page](../../web/using/editing-content.md). \n\n    ![](assets/scripting-captcha4.png)\n\n    ![](assets/scripting-captcha5.png)\n\n>[!IMPORTANT]\n>\n>For reCAPTCHA integration, you have to add client-side JavaScript in the HTML (in `<head>...</head>`):\n>\n>`<script src=\"https://www.google.com/recaptcha/api.js\" async defer></script>`\n\n### Campaign captcha\n\n```javascript\nvar captchaID = request.getParameter(\"captchaID\");\nvar captchaValue = request.getParameter(\"captchaValue\");\n  \nif( !CaptchaValidate(captchaID, captchaValue) ) {\n  serverForm.logInputError(\"captchaValue\",\n                           \"The characters you typed for the captcha must match the image ones.\",\n                           \"captchaValue\")\n  ctx.vars.captchaValid = false\n}\nelse\n  ctx.vars.captchaValid = true\n```\n\nLine 6: you can put any kind of error message.\n\n### Google recaptcha\n\nPlease refer to the [official documentation](https://developers.google.com/recaptcha/docs/verify).\n\n```javascript\nctx.vars.captchaValid = false\nvar gReCaptchaResponse = request.getParameter(\"g-recaptcha-response\");\n  \n// Call reCaptcha API to validate it\nvar req = new HttpClientRequest(\"https://www.google.com/recaptcha/api/siteverify\")\nreq.method = \"POST\"\nreq.header[\"Content-Type\"] = \"application/x-www-form-urlencoded\"\nreq.body = \"secret=YOUR_SECRET_HERE&response=\" + encodeURIComponent(gReCaptchaResponse)\nreq.execute()\nvar response = req.response\nif( response.code == 200 ) {\n  captchaRes = JSON.parse(response.body.toString(response.codePage));\n  ctx.vars.captchaValid = captchaRes.success\n}\n  \nif( ctx.vars.captchaValid == false ) {\n  serverForm.logInputError(\"reCaptcha\",\n                           \"Please validate the captcha\",\n                           \"reCaptcha\")\n  logInfo(\"reCaptcha not validated\")\n}\n```\n\nTo use JSON.parse you have to include \"shared/json2.js\" in your webApp:\n\n![](assets/scripting-captcha6.png)\n\nSince build 8797, in order to use the verification API URL, you have to add it to the allowlist in the serverConf file by adding in urlPermission node:\n\n`<url dnsSuffix=\"www.google.com\" urlRegEx=\"https://www.google.com/recaptcha/api/siteverify\"/>`\n","headers":[["title","Scripting and coding guidelines"],["description","Learn more about the guidelines to follow when developing in Adobe Campaign (workflows, Javascript, JSSP, etc.)"],["feature","Installation, Instance Settings"],["topic-tags","prerequisites-and-recommendations-"]],"sections":[{"section":"Scripting and coding guidelines","sectionId":"99b684ca-ed9e-4584-a85a-7b2f29faa734","paragraphs":[]},{"section":"Scripting","sectionId":"3991fc75-7198-421d-898b-49b3e19efdec","paragraphs":["For more details, refer to Campaign JSAPI documentation.","If you script using workflow, web applications, jssp, follow these best practices:","Try to avoid using SQL statements as much as you can.","If you need to, use parameterized (prepare statement) functions instead of string concatenation.","Bad practice:","sqlGetInt( \"select iRecipientId from NmsRecipient where sEmail ='\" + request.getParameter('email') +  \"'  limit 1\" )","Good practice:","sqlGetInt( \"select iRecipientId from NmsRecipient where sEmail = $(sz) limit 1\", request.getParameter('email'));","IMPORTANT","sqlSelect doesn't support this feature, so you have to use the query function of DBEngine class:","var cnx = application.getConnection()\nvar stmt = cnx.query(\"SELECT sFirstName, sLastName FROM NmsRecipient where sEmail = $(sz)\", request.getParameter('email'))\nfor each(var row in stmt) logInfo(row[0] + \" : \" + row[1])\ncnx.dispose()","To avoid SQL injections, SQL functions must be added to the allowlist to be used in Adobe Campaign. Once they are added to the allowlist, they become visible to your operators in the expression editor. Refer to this page.","IMPORTANT","If you are using a build that is older than 8140, the XtkPassUnknownSQLFunctionsToRDBMS option might be set to '1'. If you want to secure your database, delete this option (or set it to '0').","If you are using user input to build filters in queries or SQL statements, you always have to escape them (refer to Campaign JSAPI documentation - Data protection: escaping functions). These functions are:","NL.XML.escape(data)\nNL.SQL.escape(data)\nNL.JS.escape(data)\nNL.XML.escapeAttribute(data)"]},{"section":"Securing your new data model","sectionId":"b95f7a12-eb4e-44ed-acad-e5b4c2889e88","paragraphs":[]},{"section":"Folder base","sectionId":"c6a225a4-d26e-489f-a38a-4ba8f5089531","paragraphs":["Refer to these pages:","Folder access properties\nLinked folder"]},{"section":"Named rights","sectionId":"749cec15-60f3-44b4-87f2-00c71ad089cd","paragraphs":["In addition to the folder-based security model, you can use named rights to limit operator actions:","You can add some system filters (sysFilter) to prevent reading/writing to your data (see this page).","<sysFilter name=\"writeAccess\">    \n    <condition enabledIf=\"hasNamedRight('myNewRole')=false\" expr=\"FALSE\"/>  \n</sysFilter>","You can also protect some actions (SOAP method) defined in schemas. Just set the access attribute with the corresponding named right as the value.","<method name=\"grantVIPAccess\" access=\"myNewRole\">\n    <parameters>\n...\n    </parameters>\n</method>","For more on this, refer to this page.","IMPORTANT","You can use named rights in the command node in a navtree. It gives a better user experience but doesn't provide any protection (use only client side to hide / disable them). You have to use the access attribute."]},{"section":"Overflow table","sectionId":"ee247985-322a-4fbd-a249-939ce37560b6","paragraphs":["If you need to protect confidential data (part of a schema) depending on the operator access level, do not hide them in the form definition (enabledIf/visibleIf conditions).","The full entity is loaded by the screen, you can also display them in column definition. To do this, you have to create an overflow table. Refer this page."]},{"section":"Adding captchas in web applications","sectionId":"f9d5fbf4-d22b-48b6-9489-49fce02440cb","paragraphs":["It is a good practice to add a captcha in public landing pages/subscription pages. Unfortunately, adding a captcha in DCE (Digital Content Editor) pages is not easy. We will show you how to add a v5 captcha or a Google reCAPTCHA.","The general way to add a captcha in the DCE is to create a personalization block to include it easily within the page content. You will have to add a Script activity and a Test."]},{"section":"Personalization block","sectionId":"8f900820-bdf9-4dea-966c-84cd439f473a","paragraphs":["Go to Resources > Campaign Management > Personalization blocks and create a new one.","Use the Web application content type and check Visible in the customization menus.","For more information, refer to this page.","Here is an example of a Campaign captcha:","<%\nvar captchaID = CaptchaIDGen();\n%>\n<img src=\"/nms/jsp/captcha.jsp?captchaID=<%=captchaID%>&width=200&height=50&minWordSize=8&maxWordSize=8\"/>\n<input id=\"captchaValue\" name=\"captchaValue\" <%= String(ctx.vars.captchaValid) === \"false\" ? class=\"ui-state-error\" : \"\" %>>\n<input type=\"hidden\" name=\"captchaID\" value=\"<%=captchaID%>\"/>\n<%\nif( serverForm.isInputErroneous(\"captchaValue\") ) {\n%>\n<script type=\"text/javascript\"> \n$(\"#captchaValue\").addClass(\"ui-state-error\")\n</script>\n<%\n}\n%>","Lines 1 to 6 generate all needed inputs.","Lines 7 to the end handle errors.","Line 4 allows you to change captcha gray box size (width/height) and the length of generated word (minWordSize/maxWordSize).","Before using Google reCAPTCHA, you must register on Google and create a new reCAPTCHA site.","<div class=\"g-recaptcha\" data-sitekey=\"YOUR_SITE_KEY\"></div>","You should be able to disable the validation button, but as we don't have any standard button/link, it's better to do it in the HTML itself. To learn how to do it, refer to this page."]},{"section":"Updating your web application","sectionId":"5a1f23d4-3871-4553-b7d1-4f80fb11be42","paragraphs":["Access the properties of your web application to add a boolean variable named captchaValid.","","Between the last page and the Storage activity, add a Script and a Test.","Plug the branch True to the Storage and the other one to the page which will have the captcha.","","Edit the condition of the branch True with \"[vars/captchaValid]\" equals True.","","Edit the Script activity. The content will depend on the chosen captcha engine.","Finally, you can add your personalized block in the page: refer to this page.","IMPORTANT","For reCAPTCHA integration, you have to add client-side JavaScript in the HTML (in <head>...</head>):","<script src=\"https://www.google.com/recaptcha/api.js\" async defer></script>"]},{"section":"Campaign captcha","sectionId":"249a2cb8-4d24-4424-b00b-c249b6d24778","paragraphs":["var captchaID = request.getParameter(\"captchaID\");\nvar captchaValue = request.getParameter(\"captchaValue\");\n  \nif( !CaptchaValidate(captchaID, captchaValue) ) {\n  serverForm.logInputError(\"captchaValue\",\n                           \"The characters you typed for the captcha must match the image ones.\",\n                           \"captchaValue\")\n  ctx.vars.captchaValid = false\n}\nelse\n  ctx.vars.captchaValid = true","Line 6: you can put any kind of error message."]},{"section":"Google recaptcha","sectionId":"774687ef-55fa-4f46-9514-98d65268c22a","paragraphs":["Please refer to the official documentation.","ctx.vars.captchaValid = false\nvar gReCaptchaResponse = request.getParameter(\"g-recaptcha-response\");\n  \n// Call reCaptcha API to validate it\nvar req = new HttpClientRequest(\"https://www.google.com/recaptcha/api/siteverify\")\nreq.method = \"POST\"\nreq.header[\"Content-Type\"] = \"application/x-www-form-urlencoded\"\nreq.body = \"secret=YOUR_SECRET_HERE&response=\" + encodeURIComponent(gReCaptchaResponse)\nreq.execute()\nvar response = req.response\nif( response.code == 200 ) {\n  captchaRes = JSON.parse(response.body.toString(response.codePage));\n  ctx.vars.captchaValid = captchaRes.success\n}\n  \nif( ctx.vars.captchaValid == false ) {\n  serverForm.logInputError(\"reCaptcha\",\n                           \"Please validate the captcha\",\n                           \"reCaptcha\")\n  logInfo(\"reCaptcha not validated\")\n}","To use JSON.parse you have to include \"shared/json2.js\" in your webApp:","Since build 8797, in order to use the verification API URL, you have to add it to the allowlist in the serverConf file by adding in urlPermission node:","<url dnsSuffix=\"www.google.com\" urlRegEx=\"https://www.google.com/recaptcha/api/siteverify\"/>"]}]}